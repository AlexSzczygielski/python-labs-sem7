# This workflow will run exercises and update the tasks.md files

name: Run Exercises

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  run-exercises:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          
      - name: Determine which Python files to run
        id: files
        run: |
          # Ignore lab4
          if [ ! -f ".tasks_initialized" ]; then
            echo "ALL_FILES=true" >> $GITHUB_ENV
            echo "Initial run: will process all Python files"
          else
            # Get changed Python files in this push
            CHANGED_FILES=$(git diff --name-only ${{ github.sha }} ${{ github.event.before }} | grep '\.py$' | grep -v '^lab4/')
            echo "CHANGED_FILES=$CHANGED_FILES" >> $GITHUB_ENV
            echo "Initial run already done, will process only changed Python files"
          fi
          
      - name: Run scripts and output to answers.md in each lab
        run: |
          # Find all lab directories containing Python scripts
          LAB_DIRS=$(find . -type f -name "ex*.py" -exec dirname {} \; | sort -u)
      
          for lab in $LAB_DIRS; do
            echo "Processing lab: $lab"
      
            # Overwrite answers.md in this lab folder
            echo "# Script Outputs" > "$lab/answers.md"
      
            if [ "$ALL_FILES" = "true" ]; then
              # Run all ex*.py in this lab, excluding lab4
              for file in $(find "$lab" -maxdepth 1 -type f -name "ex*.py" ! -path "./lab4/*"); do
                echo "### $file" >> "$lab/answers.md"
                echo '```' >> "$lab/answers.md"
                python "$file" >> "$lab/answers.md" 2>&1
                echo '```' >> "$lab/answers.md"
              done
              # Mark initial run as done
              touch .tasks_initialized
              git add .tasks_initialized
            else
              # Run only changed Python files in this lab
              for file in $CHANGED_FILES; do
                if [[ "$file" == "$lab/"* ]]; then
                  echo "### $file" >> "$lab/answers.md"
                  echo '```' >> "$lab/answers.md"
                  python "$file" >> "$lab/answers.md" 2>&1
                  echo '```' >> "$lab/answers.md"
                fi
              done
            fi
          done

      - name: Add link to answers.md in tasks.md
        run: |
          for taskfile in $(find . -name "tasks.md"); do
            dir=$(dirname "$taskfile")
            # Add link if it doesn't exist
            grep -qxF "[Answers](answers.md)" "$taskfile" || \
            echo "[Answers](answers.md)" >> "$taskfile"
          done
          git add $(find . -name "tasks.md")
          
      - name: Commit answers.md
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git add $(find . -name "answers.md" -o -name "tasks.md")
          git commit -m "Update answers" || echo "No changes to commit"
          git push
